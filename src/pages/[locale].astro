---
import type {GetStaticPaths} from "astro";
import {AstroError} from "astro/errors";

import {loadProfile, type ProfileName} from "../profile";

import {getRegisteredLocales, loadLocaleMetadata} from "../locale";

import ProfileLayout from "../layouts/ProfileLayout.astro";
import ProfileInformationHeading from "../components/profile/ProfileInformationHeading.astro";
import ProfilePicture from "../components/profile/ProfilePicture.astro";

import Panel from "../components/panel/Panel.astro";
import PanelHeading from "../components/panel/PanelHeading.astro";

export const getStaticPaths = (async () => {
  const locales = getRegisteredLocales();
  if (!locales) {
    return [];
  }

  const localeCodes = locales.flatMap((locale) => typeof locale === "string" ? locale : locale.codes);
  const localeMetadatas = await Promise.all(localeCodes.map(async locale => await loadLocaleMetadata(locale)));

  return await Promise.all(localeCodes.map(async (locale) => {
    try {
      return {
        "params": {locale},
        "props": {
          "profile": await loadProfile(locale, import.meta.env.PROFILE as ProfileName | undefined),
          localeMetadatas
        }
      };
    } catch (error) {
      /*
       * For some reason Astro doesnt invoke Vite's Error UI when
       * error is being thrown from async function, so we need to
       * do such weird forwarding things here: 
       */
      if (error instanceof AstroError) {
        throw new AstroError(error.message, error.hint);
      }
      if (error instanceof Error) {
        throw new AstroError(error.message);
      }
      throw error;
    }
  }));
}) satisfies GetStaticPaths;

const {profile} = Astro.props;
---

<ProfileLayout locale={Astro.params.locale} names={profile.contacts.names}>
  <ProfileInformationHeading slot="header" names={profile.contacts.names} role={profile.contacts.role} />
  <ProfilePicture slot="aside-top" path={profile.contacts.picture.path} description={profile.contacts.picture.description} />
  <Panel significance={200}>
    <PanelHeading>Example Panel Heading</PanelHeading>
    <p>This is an example panel paragraph</p>
  </Panel>
</ProfileLayout>
